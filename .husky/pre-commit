#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "🔍 Running pre-commit checks..."

# Run lint-staged (includes component test validation)
npx lint-staged

if [ $? -ne 0 ]; then
  echo "❌ Lint-staged checks failed"
  exit 1
fi

# Check if any component tests were modified and run them
COMPONENT_TESTS=$(git diff --cached --name-only | grep -E "\.cy\.tsx$|\.stories\.tsx$")

if [ ! -z "$COMPONENT_TESTS" ]; then
  echo "🧪 Component tests modified, running quick validation..."
  
  # Run a quick test to make sure Cypress can load the components
  npm run test:ct -- --headless --spec "**/components/**/*.cy.tsx" --run-timeout 30000 > /dev/null 2>&1
  
  if [ $? -ne 0 ]; then
    echo "⚠️  Warning: Some component tests may have issues. Run 'npm run test:ct' to verify."
    echo "🚀 Continuing with commit (tests will be verified in CI)..."
  else
    echo "✅ Component tests validation passed"
  fi
fi

echo "✨ Pre-commit checks completed successfully!"
