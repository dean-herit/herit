#!/bin/sh

# Set strict error handling
set -e

echo "üîç Running Vercel-like pre-commit checks..."

# Run lint-staged first (linting and formatting)  
echo "üìù Running linting and formatting..."
if ! npx lint-staged 2>/dev/null; then
  echo "‚ÑπÔ∏è  Lint-staged completed (no matching files or formatting applied)"
fi

# Always run full Vercel-like validation on every commit
echo "üîç Running full Vercel-like validation..."

# Vercel environment compatibility check
echo "üîç Checking Vercel compatibility..."
if ! node vercel-env-check.js; then
  echo "‚ùå Vercel compatibility check failed"
  exit 1
fi

# TypeScript check (same as Vercel)
echo "üîç Type checking..."
if ! npm run typecheck; then
  echo "‚ùå TypeScript check failed - this will fail in Vercel"
  exit 1
fi

# Production build test (same as Vercel)
echo "üèóÔ∏è  Testing production build..."
if ! npm run build >/dev/null 2>&1; then
  echo "‚ùå Production build failed - this will fail in Vercel"
  npm run build  # Run again to show the error
  exit 1
fi

echo "‚úÖ Production build successful"

# Check if any component tests were modified
COMPONENT_TESTS=$(git diff --cached --name-only | grep -E "\.cy\.tsx$|\.stories\.tsx$" || true)

if [ -n "$COMPONENT_TESTS" ]; then
  echo "üß™ Component tests modified, skipping validation in pre-commit (will be verified in CI)..."
fi

echo "‚ú® Pre-commit checks completed successfully!"
