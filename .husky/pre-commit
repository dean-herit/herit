#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Visual Pre-commit Hook - Opens Test Dashboard for Real-time Feedback
echo "ğŸšª Pre-commit Quality Gates with Visual Dashboard"
echo ""

# Open test status dashboard for visual feedback
echo "ğŸ“Š Opening Test Status Dashboard..."
open http://localhost:3000/test-status 2>/dev/null || true

# Give dashboard a moment to load
sleep 2

# Trigger comprehensive test run via API
echo "ğŸš€ Triggering comprehensive test execution..."
echo "   ğŸ“± Watch progress at: http://localhost:3000/test-status"
echo ""

# Start the test run in the background and get the process
curl -s -X POST http://localhost:3000/api/test-runner \
  -H "Content-Type: application/json" \
  -d '{"streaming": false}' > /tmp/husky-test-results.json &

TEST_PID=$!

# Show progress dots while waiting
printf "   ğŸ”„ Running tests"
while kill -0 $TEST_PID 2>/dev/null; do
  printf "."
  sleep 2
done
printf "\n"

# Wait for the background process to complete
wait $TEST_PID
TEST_EXIT_CODE=$?

# Read the results
if [ -f /tmp/husky-test-results.json ] && [ $TEST_EXIT_CODE -eq 0 ]; then
  # Parse the results to check if tests passed
  if grep -q '"overallSuccess":true' /tmp/husky-test-results.json; then
    echo "   âœ… All tests passed!"
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "âœ… COMMIT APPROVED"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "ğŸ‰ Quality gates passed:"
    echo "  âœ… Backend API Tests"
    echo "  âœ… Code Quality (ESLint)"  
    echo "  âœ… Build Validation"
    echo "  âœ… Component Tests"
    echo ""
    echo "ğŸ“Š View detailed results at: http://localhost:3000/test-status"
    echo "ğŸš€ Ready for deployment!"
    
    # Cleanup
    rm -f /tmp/husky-test-results.json
    exit 0
  else
    echo "   âŒ Tests failed!"
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "âŒ COMMIT BLOCKED"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "ğŸ’¡ Check the dashboard for detailed failure analysis:"
    echo "   ğŸ”— http://localhost:3000/test-status"
    echo ""
    echo "ğŸ’¡ Use the 'ğŸ“‹ Copy Debug Report' button to share issues with Claude"
    echo ""
    
    # Cleanup
    rm -f /tmp/husky-test-results.json
    exit 1
  fi
else
  echo "   âŒ Failed to execute tests"
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "âŒ COMMIT BLOCKED"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  echo "ğŸ’¡ Ensure dev server is running: npm run dev"
  echo "ğŸ’¡ Then check: http://localhost:3000/test-status"
  
  # Cleanup
  rm -f /tmp/husky-test-results.json
  exit 1
fi
